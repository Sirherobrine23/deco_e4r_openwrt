!function(w){w.su.moduleManager.define("firmwareDeco",{views:["firmwareDecoView"],models:["firmwareTypeM"],stores:["onlineUpgradeStore","firmwareTypeS"],services:["ajax","vtype","language","device"],deps:["main"],listeners:{"ev_on_launch":function(e,r,a,i,o,t,n){var c=n.device.getCurrentMode();r.notFirstLoad=!1,o.onlineUpgradeStore.load(),"RE"===c.workMode?a.firmwareDecoView.onlineUpgradeCtn.hide():a.firmwareDecoView.onlineUpgradeCtn.show()}},init:function(c,s,a,d,e,r){this.configViews({id:"firmwareDecoView",items:[{id:"firmware-list-grid",configs:{minLines:0,columns:[{text:w.su.CHAR.FIRMWARE.TYPE,dataIndex:"deviceModel",width:"12%",renderer:function(e){var r,a;switch(e){case"M1300":case"M5":case"M9Plus":case"P7":r="icon-device-m5";break;case"M4":case"E4":case"W2400":case"M3":case"E3":case"M4R":case"AC1200":r="icon-device-m4r";break;case"M3W":r="icon-device-m3w";break;case"X20":case"X60":r="icon-device-x20";break;default:r="icon-device-m5"}return a='<a href="javascript:void(0)" class="grid-content-btn" style=\'cursor: default\'>',a+="<span class='icon-device "+r+"'></span>",a+="</a>"}},{text:w.su.CHAR.FIRMWARE.DEVICE_NAME,dataIndex:"nickName",width:"20%",renderer:function(e,r){var a="";return"disconnected"===r.groupStatus&&(a="("+w.su.CHAR.REBOOT.OFFLINE+")"),"custom"!==e?w.su.escapeHtml(e)+a:w.su.escapeHtml(w.su.b64Decode(r.customNickname))+a}},{text:w.su.CHAR.FIRMWARE.MODEL,dataIndex:"deviceModel",width:"15%",renderer:function(e,r){var a=r.hardwareVer;return null!==a&&(e+="("+a+")"),e}},{text:w.su.CHAR.FIRMWARE.FIRMWARE_VERSION,dataIndex:"softwareVer",renderer:function(e){return e}},{text:w.su.CHAR.FIRMWARE.LATEST_FIRMWARE_VERSION,dataIndex:"newVersion",renderer:function(e,r){var a;switch(r.deviceModel){case"M4R":a="https://www.tp-link.com/en/download/Deco-M4.html#Firmware";break;case"P7":a="https://www.tp-link.com/en/download/Deco-P7.html#Firmware";break;case"M9Plus":a="https://www.tp-link.com/en/download/Deco-M9-Plus.html#Firmware";break;case"M5":a="https://www.tp-link.com/en/download/Deco-M5.html#Firmware";break;case"M3W":a="javascript:void(0);"}return null===e?"-":w.su.b64Decode(e)+"<a target='_blank' style='color: #4acbd6' href='"+a+"'>("+w.su.CHAR.FIRMWARE.WHATS_NEW+")</a>"}}]}}]}),this.listen({"stores.onlineUpgradeStore":{"ev_loaded":function(){var e=[];c.firmwareTypeObj={};for(var r=c.firmwareTypeObj,a=d.onlineUpgradeStore.getData(),i=!1,o=a.length-1;0<=o;o--){var t=a[o],n=t.deviceModel;"disconnected"!==t.groupStatus?(r[n]={hw_id:t.hwId,oem_id:t.oemId,device_model:t.deviceModel},t.needToUpgrade&&(i=!0)):d.onlineUpgradeStore.disable(t.key)}for(n in s.firmwareDecoView.checkUpgradesBtn.loading(!1),i?(s.firmwareDecoView.onlineUpgradeBtn.show(),w("#check-already-update").hide(),s.firmwareDecoView.firmwareCheckCont.hide()):(s.firmwareDecoView.firmwareCheckCont.show(),c.notFirstLoad&&w("#check-already-update").show(),s.firmwareDecoView.onlineUpgradeBtn.hide()),c.notFirstLoad=!0,r)e.push({value:n,name:n});d.firmwareTypeS.loadData(e)}}}),this.control({"#firmware-check-upgrades-btn":{"ev_button_click":function(){s.firmwareDecoView.checkUpgradesBtn.loading(!0),c.checkFirmware()}},"#online-upgrade-btn":{"ev_button_click":function(){c.modeFlag="online",s.firmwareDecoView.confirmUpgrade.show()}},"#manual-upgrade-file":{"ev_file_change":function(){var e=s.firmwareDecoView.firmwareFile,r=e.getFileName(),a=e.getFileSize(),i=this.checkFileName(r,"bin");""===r?e.setNormal():!0!==i?e.setError(i):0<=a&&a<1||64<a?e.setError(w.su.CHAR.ERROR["00000002"]):e.setNormal()}},"#firmware-upgrade-msg":{"ev_msg_ok":function(){"online"===c.modeFlag?c.startOnlineUpgrade():"manual"===c.modeFlag&&c.startLocalUpgrade()}},"#local-upgrade-btn":{"ev_button_click":function(){c.modeFlag="manual";var e=a.firmwareTypeM.deviceType.getValue(),r=s.firmwareDecoView.firmwareFile;r.getContainer().hasClass("error")||r.isEmpty()||(null===e?a.firmwareTypeM.deviceType.setError(w.su.CHAR.VTYPETEXT.NOT_ALLOW_TO_BE_EMPTY):a.firmwareTypeM.deviceType.setNormal(),null!==e&&s.firmwareDecoView.confirmUpgrade.show())}},"#failure-retry-msg":{"ev_msg_ok":function(){c.startOnlineUpgrade()}}})}},function(t,n,a,e,o,c){var s=0;return{checkFirmware:function(){e.onlineUpgradeStore.load({url:w.su.url("/admin/cloud?form=firmware_status"),data:{operation:"check"},timeout:3e4})},startOnlineUpgrade:function(){c.ajax.request({proxy:"firmwareDownloadProxy",success:function(){t.detectDownloadStatus()}})},detectDownloadStatus:function(){function i(){if(5===++s)return s=0,n.firmwareDecoView.progressbarWrap.hide(),n.firmwareDecoView.failRetryMsg.setContent(w.su.CHAR.ERROR["00000003"]),void n.firmwareDecoView.failRetryMsg.show();setTimeout(o,3e3)}function o(){c.ajax.request({proxy:"checkDownloadStatusProxy",success:function(e){var r=e.download_progress,a=e.status;if("fail"!==a&&"preparing"!==a){if(s=0,n.firmwareDecoView.proBar.setValue(r),100===r)return n.firmwareDecoView.proBar.setValue(100,1e3),void setTimeout(t.sendUpgradeDirective,1e3);setTimeout(o,3e3)}else i()},fail:i,error:i})}n.firmwareDecoView.proBar.reset(),n.firmwareDecoView.proBarTitle.setText(w.su.CHAR.FIRMWARE.DOWNLOADING),n.firmwareDecoView.progressbarWrap.show(),o()},sendUpgradeDirective:function(){function e(e){var r=w.su.CHAR.ERROR[e.errorCode.toString()]||w.su.CHAR.ERROR["00000004"];n.firmwareDecoView.progressbarWrap.hide(),n.firmwareDecoView.failRetryMsg.setContent(r),n.firmwareDecoView.failRetryMsg.show()}c.ajax.request({proxy:"sendUpgradeDirectiveProxy",success:function(e){var r=1e3*e.upgrade_time,a=1e3*e.reboot_time;n.firmwareDecoView.proBarTitle.setText(w.su.CHAR.FIRMWARE.UPGRADING),n.firmwareDecoView.proBar.reset(),n.firmwareDecoView.proBar.animate({duration:r,percentageStart:0,percentageEnd:100,callback:function(){n.firmwareDecoView.progressbarWrap.hide(),o.main.startReboot(a,function(){localStorage&&localStorage.setItem("token",""),location.href="https://tplinkdeco.net"})}})},fail:e,error:e})},startLocalUpgrade:function(){var e=a.firmwareTypeM.deviceType.getValue(),r=t.firmwareTypeObj[e];n.firmwareDecoView.proBar.reset(),n.firmwareDecoView.firmwareChecking.show(),n.firmwareDecoView.firmwareChecking.setText(w.su.CHAR.FIRMWARE.UPGRADING),c.ajax.upload({proxy:"uploadFirmwareProxy",fileId:"manual-upgrade-file",data:{hw_id:r.hw_id,oem_id:r.oem_id,device_model:r.device_model},timeout:72e4,success:function(e){t.sendLocalUpgradeDirective()},fail:function(){n.firmwareDecoView.firmwareChecking.hide()},error:function(){n.firmwareDecoView.firmwareChecking.hide()}})},sendLocalUpgradeDirective:function(){c.ajax.request({proxy:"sendLocalUpgradeDirectiveProxy",success:function(e){var r=1e3*e.upgrade_time,a=6e4,i=!0;n.firmwareDecoView.firmwareChecking.hide(),n.firmwareDecoView.proBarTitle.setText(w.su.CHAR.FIRMWARE.UPGRADING),n.firmwareDecoView.progressbarWrap.show(),n.firmwareDecoView.proBar.animate({duration:r,percentageStart:0,percentageEnd:100,callback:function(){i&&(n.firmwareDecoView.progressbarWrap.hide(),o.main.startReboot(a,function(){localStorage&&localStorage.setItem("token",""),location.href="https://tplinkdeco.net"}))}}),1===e.upgrade_number&&1===e.upgrade_self_only||setTimeout(function(){c.ajax.request({proxy:"checkUpgradeStatusProxy",preventFailEvent:!0,data:{operation:"check_upgrade"},success:function(e){a=1e3*e.reboot_time},fail:function(e,r){i=!1,n.firmwareDecoView.progressbarWrap.hide(),w.su.CHAR.ERROR[r]&&o.main.showError(w.su.CHAR.ERROR[r])}})},6e4)},fail:function(e,r){n.firmwareDecoView.firmwareChecking.hide(),w.su.CHAR.ERROR[r]&&o.main.showError(w.su.CHAR.ERROR[r])},error:function(){n.firmwareDecoView.firmwareChecking.hide()}})},checkFileName:function(e,r){return c.vtype.validate(e,{vtype:"string_file",extension:r})}}})}(jQuery);